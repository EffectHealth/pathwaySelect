<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PointerEvents Drag & Drop - Always Re-droppable Chips</title>
  <link 
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" 
    rel="stylesheet"
  >
  <style>
    * {
      font-family: 'Montserrat', sans-serif;
      margin: 0; 
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-drag: none;
      -webkit-touch-callout: none;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: #fafafa;
      width: 100%;
      min-height: 100vh;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 20px;
      color: #333;
    }

    /* The container that holds everything */
    #drag-container {
      position: relative; /* Important so chips can use absolute coords */
      width: 800px;       /* Adjust as needed */
      min-height: 700px;  /* Enough height for placeholders & display */
      border: 2px solid #ccc;
      background: #fff;
      margin-bottom: 40px;
      overflow: hidden;
    }

    .row-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
    }
    .row {
      display: flex;
      justify-content: center;
      gap: 40px;
    }
    .placeholder-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 80px;
    }
    .placeholder {
      width: 80px;
      height: 80px;
      border: 2px dotted #999;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .placeholder-label {
      font-weight: 900;
      font-size: 13px;
      color: #333;
      text-align: center;
      margin-top: 10px;
      line-height: 1.2;
    }
    .placeholder-label span.weeks {
      font-weight: normal;
      color: #666;
    }

    /* The chips layer */
    #chips-layer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; 
    }

    .chip {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute; /* inside #chips-layer */
      touch-action: none; 
      cursor: grab;
      pointer-events: auto; /* so we can drag it (override parent's none) */
      z-index: 10;          /* so chip is above the placeholder */
    }
    .chip:active {
      cursor: grabbing;
    }
    .chip img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      pointer-events: none; 
    }

    /* Pathway display area */
    #pathway-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    #pathway-img-box {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 300px;
      height: 170px;
      background: rgba(128, 128, 128, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }
    #pathway-button-box {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 300px;
      height: 50px;
      background: rgba(128, 128, 128, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }
    #pathway-img {
      display: block;
      width: 100%;
      height: auto;
      visibility: hidden;
    }
    #pathway-button {
      display: block;
      text-decoration: none;
      font-weight: 900;
      color: white;
      background: #999966;
      padding: 10px 20px;
      border-radius: 6px;
      visibility: hidden;
      transition: background 0.2s;
    }
    #pathway-button:hover {
      background: #285e8e;
    }

    @media (max-width: 768px) {
      #drag-container {
        width: 90%;
        min-height: 600px;
      }
      .row {
        flex-direction: column;
        gap: 20px;
      }
      .placeholder {
        width: 50px;
        height: 50px;
      }
      .chip {
        width: 48px;
        height: 48px;
      }
      #pathway-img-box, #pathway-button-box {
        width: 90%;
        height: auto;
      }
      #pathway-button {
        font-size: 14px;
        padding: 8px 16px;
      }
    }
  </style>
</head>
<body>

<div id="drag-container">
  <div class="row-wrapper">
    <!-- ROW of ORIGINS (1,2,3,4) -->
    <div class="row">
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="origin1"></div>
        <div class="placeholder-label">Physical<br>Activity</div>
      </div>
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="origin2"></div>
        <div class="placeholder-label">Comprehensive<br>Nutrition</div>
      </div>
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="origin3"></div>
        <div class="placeholder-label">Restful<br>Sleep</div>
      </div>
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="origin4"></div>
        <div class="placeholder-label">Stress<br>Management</div>
      </div>
    </div>

    <!-- ROW of POSITIONS (a,b,c,d) -->
    <div class="row">
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="a"></div>
        <div class="placeholder-label">Semester 1<br><span class="weeks">(Weeks 1–13)</span></div>
      </div>
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="b"></div>
        <div class="placeholder-label">Semester 2<br><span class="weeks">(Weeks 14–26)</span></div>
      </div>
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="c"></div>
        <div class="placeholder-label">Semester 3<br><span class="weeks">(Weeks 27–29)</span></div>
      </div>
      <div class="placeholder-wrapper">
        <div class="placeholder" data-slot="d"></div>
        <div class="placeholder-label">Semester 4<br><span class="weeks">(Weeks 40–52)</span></div>
      </div>
    </div>
  </div>

  <div id="pathway-display">
    <div id="pathway-img-box">
      <img id="pathway-img" src="" alt="Pathway Image">
    </div>
    <div id="pathway-button-box">
      <a id="pathway-button" href="#" target="_blank">Pathway Title</a>
    </div>
  </div>

  <!-- A layer for absolutely positioned chips -->
  <div id="chips-layer"></div>
</div>

<script>
/* -----------------------------
   (1) Data Setup
----------------------------- */
const validSlots = {
  "1": ["origin1","a","b","c","d"],
  "2": ["origin2","a","b","c","d"],
  "3": ["origin3","a","b","c","d"],
  "4": ["origin4","a","b","c","d"]
};

const slotMap = {
  origin1: "1",
  origin2: "2",
  origin3: "3",
  origin4: "4",
  a: null,
  b: null,
  c: null,
  d: null
};

function originSlot(letter) {
  return "origin" + letter;
}

const images = {
  "1": "https://static.wixstatic.com/media/048b4b_bf890793ede846d1a9b50ac133ec7002~mv2.png",
  "2": "https://static.wixstatic.com/media/048b4b_54cca8d4592245788aa47d203da6c5a2~mv2.png",
  "3": "https://static.wixstatic.com/media/048b4b_cc7c6a363a9a4cdd93e298a2014b79ed~mv2.png",
  "4": "https://static.wixstatic.com/media/048b4b_a4c341c0ce1b4084bfb6adccb91045af~mv2.png"
};

const pathways = {
  "1234": {
    title: "Preventative Health: Foundation Pathway",
    url: "https://preventativehealthcourse.effecttherapy.ca/bundles/preventative-health-foundation-pathway-1234",
    image: "https://files.cdn.thinkific.com/bundles/bundle_card_image_000/210/784/1735430581.original.png"
  },
  "1243": {
    title: "Preventative Health: Energy Flow Pathway",
    url: "https://preventativehealthcourse.effecttherapy.ca/bundles/preventative-health-energy-flow-pathway-1243",
    image: "https://files.cdn.thinkific.com/bundles/bundle_card_image_000/210/790/1735430889.original.png"
  },
  // ... etc. your full pathways object ...
  "4321": {
    title: "Preventative Health: Zenith Pathway",
    url: "https://preventativehealthcourse.effecttherapy.ca/bundles/preventative-health-zenith-pathway-4321",
    image: "https://files.cdn.thinkific.com/bundles/bundle_card_image_000/210/813/1735434511.original.png"
  }
};

const chipsLayer = document.getElementById("chips-layer");
const dragContainerRect = document.getElementById("drag-container").getBoundingClientRect();

/* -----------------------------
   (2) Create Chips
----------------------------- */
["1", "2", "3", "4"].forEach(letter => {
  createChip(letter, `origin${letter}`);
});

function createChip(letter, slotId) {
  const chipDiv = document.createElement("div");
  chipDiv.classList.add("chip");
  chipDiv.dataset.letter = letter;

  const img = document.createElement("img");
  img.src = images[letter];
  chipDiv.appendChild(img);

  chipsLayer.appendChild(chipDiv);

  // position the chip at its origin circle
  positionChipOverSlot(chipDiv, slotId);

  // pointer events
  chipDiv.addEventListener("pointerdown", onPointerDown);
}

// Center a chip over the given slot
function positionChipOverSlot(chipEl, slotId) {
  const slotEl = document.querySelector(`[data-slot='${slotId}']`);
  if (!slotEl) return;
  const slotRect = slotEl.getBoundingClientRect();

  const cx = dragContainerRect.left;
  const cy = dragContainerRect.top;

  // If you need a small offset to line it up, adjust:
  const x = slotRect.left + (slotRect.width / 2) - cx - (chipEl.offsetWidth / 2);
  const y = slotRect.top  + (slotRect.height / 2) - cy - (chipEl.offsetHeight / 2);

  chipEl.style.left = (x) + "px";
  chipEl.style.top  = (y) + "px";
}

/* -----------------------------
   (3) Pointer-based Drag
----------------------------- */
let draggedChip = null;
let oldSlot = null;
let offsetX = 0;
let offsetY = 0;
let isDragging = false;

function onPointerDown(e) {
  e.preventDefault();
  draggedChip = e.currentTarget;
  const letter = draggedChip.dataset.letter;

  oldSlot = findSlotOfLetter(letter);
  draggedChip.setPointerCapture(e.pointerId);

  // Bring to front while dragging
  draggedChip.style.zIndex = 9999;

  draggedChip.addEventListener("pointermove", onPointerMove);
  draggedChip.addEventListener("pointerup", onPointerUp);
  isDragging = true;

  // offset from pointer to chip top-left
  const chipRect = draggedChip.getBoundingClientRect();
  offsetX = e.clientX - chipRect.left;
  offsetY = e.clientY - chipRect.top;
}

function onPointerMove(e) {
  if (!isDragging || !draggedChip) return;
  e.preventDefault();

  const x = e.clientX - dragContainerRect.left - offsetX;
  const y = e.clientY - dragContainerRect.top  - offsetY;

  const maxX = dragContainerRect.width - draggedChip.offsetWidth;
  const maxY = dragContainerRect.height - draggedChip.offsetHeight;

  draggedChip.style.left = Math.max(0, Math.min(x, maxX)) + "px";
  draggedChip.style.top  = Math.max(0, Math.min(y, maxY)) + "px";
}

function onPointerUp(e) {
  e.preventDefault();
  if (!draggedChip) return;

  draggedChip.releasePointerCapture(e.pointerId);
  draggedChip.removeEventListener("pointermove", onPointerMove);
  draggedChip.removeEventListener("pointerup", onPointerUp);
  isDragging = false;

  // Return chip zIndex to normal
  draggedChip.style.zIndex = 10;

  let target = document.elementFromPoint(e.clientX, e.clientY);
  if (target && target.classList.contains("chip")) {
    target = target.parentElement;
  }

  const letter = draggedChip.dataset.letter;
  if (target && target.classList.contains("placeholder")) {
    const targetSlot = target.dataset.slot;
    if (
      ["a","b","c","d"].includes(targetSlot) &&
      validSlots[letter].includes(targetSlot) &&
      slotMap[targetSlot] !== letter
    ) {
      // occupant logic
      const occupant = slotMap[targetSlot];
      if (occupant) {
        const occupantChip = findChipByLetter(occupant);
        if (occupantChip) {
          forceMoveChipToSlot(occupantChip, targetSlot, originSlot(occupant));
        }
        slotMap[targetSlot] = null;
      }
      forceMoveChipToSlot(draggedChip, oldSlot, targetSlot);
      updatePathwayDisplay();
      draggedChip = null;
      oldSlot = null;
      return;
    }
  }

  // revert if invalid
  revertChip(draggedChip, oldSlot);
  draggedChip = null;
  oldSlot = null;
  updatePathwayDisplay();
}

/* Revert chip to its origin */
function revertChip(chipEl, fromSlot) {
  const letter = chipEl.dataset.letter;
  const home = originSlot(letter);
  forceMoveChipToSlot(chipEl, fromSlot, home);
}

/* Move a chip to a slot */
function forceMoveChipToSlot(chipEl, fromSlot, toSlot) {
  const occupant = slotMap[toSlot];
  if (occupant && occupant !== chipEl.dataset.letter) {
    // occupant -> occupant's home
    const occupantChip = findChipByLetter(occupant);
    if (occupantChip) {
      forceMoveChipToSlot(occupantChip, toSlot, originSlot(occupant));
    }
    slotMap[toSlot] = null;
  }
  slotMap[toSlot] = chipEl.dataset.letter;
  if (slotMap[fromSlot] === chipEl.dataset.letter) {
    slotMap[fromSlot] = null;
  }
  positionChipOverSlot(chipEl, toSlot);
}

/* Which slot has this letter? */
function findSlotOfLetter(letter) {
  for (const slot in slotMap) {
    if (slotMap[slot] === letter) {
      return slot;
    }
  }
  return null;
}

/* Find the .chip element for a letter */
function findChipByLetter(letter) {
  return Array.from(document.querySelectorAll(".chip"))
    .find(chip => chip.dataset.letter === letter);
}

/* -----------------------------
   (4) Update Pathway
----------------------------- */
function updatePathwayDisplay() {
  const code = [slotMap.a, slotMap.b, slotMap.c, slotMap.d].join("");
  const allFilled = slotMap.a && slotMap.b && slotMap.c && slotMap.d;

  const imgEl = document.getElementById("pathway-img");
  const btnEl = document.getElementById("pathway-button");

  imgEl.src = "";
  imgEl.style.visibility = "hidden";
  btnEl.style.visibility = "hidden";

  if (!allFilled) return;

  const p = pathways[code];
  if (!p) return;

  imgEl.src = p.image;
  imgEl.style.visibility = "visible";
  btnEl.textContent = p.title;
  btnEl.href = p.url;
  btnEl.style.visibility = "visible";
}
</script>
</body>
</html>
